{% extends "layouts/base.html" %}

{% block title %}AI è®¾ç½® - NEXUS PRIME{% endblock %}
{% block breadcrumb %}AI è®¾ç½®{% endblock %}

{% block content %}
<div class="ai-settings-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <div class="header-left">
            <div class="header-icon">
                <i class="fas fa-brain"></i>
                <span class="icon-pulse"></span>
            </div>
            <div>
                <h1>AI æ™ºèƒ½åŠ©æ‰‹è®¾ç½®</h1>
                <p>é…ç½®æ‚¨çš„ DeepSeek API Key ä»¥å¯ç”¨ AI åŠŸèƒ½</p>
            </div>
        </div>
        <a href="{{ url_for('ai.chat_page') }}" class="btn-back">
            <i class="fas fa-arrow-left"></i>
            è¿”å› AI åŠ©æ‰‹
        </a>
    </div>

    <!-- çŠ¶æ€å¡ç‰‡ -->
    <div class="status-cards">
        <div class="status-card {{ 'active' if has_key else 'inactive' }}">
            <div class="status-icon">
                <i class="fas fa-{{ 'check-circle' if has_key else 'times-circle' }}"></i>
            </div>
            <div class="status-info">
                <span class="status-label">API Key çŠ¶æ€</span>
                <span class="status-value">{{ 'å·²é…ç½®' if has_key else 'æœªé…ç½®' }}</span>
            </div>
        </div>
        
        <div class="status-card info">
            <div class="status-icon">
                <i class="fas fa-server"></i>
            </div>
            <div class="status-info">
                <span class="status-label">AI æœåŠ¡å•†</span>
                <span class="status-value">DeepSeek</span>
            </div>
        </div>
        
        <div class="status-card info">
            <div class="status-icon">
                <i class="fas fa-microchip"></i>
            </div>
            <div class="status-info">
                <span class="status-label">æ¨¡å‹ç‰ˆæœ¬</span>
                <span class="status-value">deepseek-chat</span>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®è¡¨å• -->
    <div class="settings-section">
        <div class="section-header">
            <h2><i class="fas fa-key"></i> API Key é…ç½®</h2>
            <span class="section-badge">ç§å¯†å­˜å‚¨</span>
        </div>
        
        <div class="section-content">
            <form method="POST" class="api-form" id="apiForm">
                <div class="form-group">
                    <label for="api_key">DeepSeek API Key</label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="api_key" 
                            name="api_key" 
                            placeholder="{{ saved_key if has_key else 'è¯·è¾“å…¥æ‚¨çš„ API Key (sk-...)' }}"
                            class="form-input"
                        >
                        <button type="button" class="toggle-visibility" onclick="togglePassword()">
                            <i class="fas fa-eye" id="toggleIcon"></i>
                        </button>
                    </div>
                    {% if has_key %}
                    <p class="form-hint success">
                        <i class="fas fa-check-circle"></i>
                        å·²ä¿å­˜çš„ Key: {{ saved_key }}
                    </p>
                    {% else %}
                    <p class="form-hint">
                        <i class="fas fa-info-circle"></i>
                        æ‚¨çš„ API Key å°†è¢«å®‰å…¨åŠ å¯†å­˜å‚¨ï¼Œä»…ç”¨äºè°ƒç”¨ AI æœåŠ¡
                    </p>
                    {% endif %}
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="saveBtn">
                        <i class="fas fa-save"></i>
                        ä¿å­˜è®¾ç½®
                    </button>
                    {% if has_key %}
                    <button type="button" class="btn-danger" onclick="clearApiKey()">
                        <i class="fas fa-trash-alt"></i>
                        æ¸…é™¤ Key
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- è·å– API Key æŒ‡å— -->
    <div class="guide-section">
        <div class="section-header">
            <h2><i class="fas fa-book"></i> å¦‚ä½•è·å– API Key</h2>
        </div>
        
        <div class="guide-steps">
            <div class="guide-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h4>è®¿é—® DeepSeek å®˜ç½‘</h4>
                    <p>å‰å¾€ <a href="https://platform.deepseek.com" target="_blank">platform.deepseek.com</a> æ³¨å†Œè´¦å·</p>
                </div>
            </div>
            
            <div class="guide-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h4>è¿›å…¥ API æ§åˆ¶å°</h4>
                    <p>ç™»å½•åç‚¹å‡»"API Keys"èœå•</p>
                </div>
            </div>
            
            <div class="guide-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h4>åˆ›å»º API Key</h4>
                    <p>ç‚¹å‡»"Create new API key"ç”Ÿæˆå¯†é’¥</p>
                </div>
            </div>
            
            <div class="guide-step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h4>å¤åˆ¶å¹¶ä¿å­˜</h4>
                    <p>å°†ç”Ÿæˆçš„ Key ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½è¯´æ˜ -->
    <div class="features-section">
        <div class="section-header">
            <h2><i class="fas fa-magic"></i> AI åŠŸèƒ½ä¸€è§ˆ</h2>
        </div>
        
        <div class="features-grid">
            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-comments"></i></div>
                <h4>æ™ºèƒ½å¯¹è¯</h4>
                <p>ä¸ AI è¿›è¡Œè‡ªç„¶è¯­è¨€å¯¹è¯ï¼Œè·å–å³æ—¶å¸®åŠ©</p>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-chart-pie"></i></div>
                <h4>æ•°æ®åˆ†æ</h4>
                <p>AI è‡ªåŠ¨åˆ†æä¸šåŠ¡æ•°æ®ï¼Œæä¾›æ´å¯Ÿå»ºè®®</p>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-file-invoice"></i></div>
                <h4>æŠ¥å‘Šç”Ÿæˆ</h4>
                <p>ä¸€é”®ç”Ÿæˆå„ç±»ä¸šåŠ¡æŠ¥å‘Šå’Œåˆ†ææ–‡æ¡£</p>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-boxes"></i></div>
                <h4>åº“å­˜ä¼˜åŒ–</h4>
                <p>æ™ºèƒ½åˆ†æåº“å­˜ï¼Œæä¾›è¡¥è´§å’Œä¼˜åŒ–å»ºè®®</p>
            </div>
        </div>
    </div>

    <!-- Token è®¡ç®—å™¨ -->
    <div class="token-calculator-section">
        <div class="section-header">
            <h2><i class="fas fa-calculator"></i> Token è®¡ç®—å™¨</h2>
            <span class="section-badge">è´¹ç”¨ä¼°ç®—</span>
        </div>
        
        <div class="section-content">
            <div class="calculator-layout">
                <div class="calculator-input">
                    <label for="tokenText">è¾“å…¥æ–‡æœ¬è®¡ç®— Token</label>
                    <textarea 
                        id="tokenText" 
                        placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´æ–‡æœ¬ï¼Œå®æ—¶è®¡ç®— Token æ•°é‡å’Œé¢„ä¼°è´¹ç”¨..."
                        rows="6"
                    ></textarea>
                    <div class="input-actions">
                        <button type="button" class="btn-secondary" onclick="clearTokenText()">
                            <i class="fas fa-eraser"></i> æ¸…ç©º
                        </button>
                        <button type="button" class="btn-secondary" onclick="pasteFromClipboard()">
                            <i class="fas fa-paste"></i> ç²˜è´´
                        </button>
                    </div>
                </div>
                
                <div class="calculator-results">
                    <div class="result-card primary">
                        <div class="result-icon"><i class="fas fa-coins"></i></div>
                        <div class="result-data">
                            <span class="result-value" id="tokenCount">0</span>
                            <span class="result-label">Tokens</span>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-icon"><i class="fas fa-font"></i></div>
                        <div class="result-data">
                            <span class="result-value" id="charCount">0</span>
                            <span class="result-label">å­—ç¬¦æ•°</span>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-icon"><i class="fas fa-align-left"></i></div>
                        <div class="result-data">
                            <span class="result-value" id="wordCount">0</span>
                            <span class="result-label">è¯æ•°</span>
                        </div>
                    </div>
                    
                    <div class="result-card cost">
                        <div class="result-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="result-data">
                            <span class="result-value" id="costEstimate">$0.000000</span>
                            <span class="result-label">é¢„ä¼°è´¹ç”¨ (è¾“å…¥)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="pricing-info">
                <div class="pricing-title"><i class="fas fa-info-circle"></i> DeepSeek å®šä»·å‚è€ƒ</div>
                <div class="pricing-grid">
                    <div class="pricing-item">
                        <span class="pricing-label">è¾“å…¥ (Input)</span>
                        <span class="pricing-value">$0.14 / ç™¾ä¸‡ tokens</span>
                    </div>
                    <div class="pricing-item">
                        <span class="pricing-label">è¾“å‡º (Output)</span>
                        <span class="pricing-value">$0.28 / ç™¾ä¸‡ tokens</span>
                    </div>
                    <div class="pricing-item">
                        <span class="pricing-label">è®¡ç®—æ–¹æ³•</span>
                        <span class="pricing-value" id="calcMethod">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- é¢„è®¾ Prompt ç®¡ç† -->
    <div class="settings-section prompt-section">
        <div class="section-header">
            <h2><i class="fas fa-comment-dots"></i> é¢„è®¾ Prompt æ¨¡æ¿</h2>
            <button type="button" class="btn-add-prompt" onclick="addNewPrompt()">
                <i class="fas fa-plus"></i> æ·»åŠ æ¨¡æ¿
            </button>
        </div>
        
        <div class="section-content">
            <div class="prompt-list" id="promptList">
                <!-- é»˜è®¤æ¨¡æ¿ -->
                <div class="prompt-card" data-id="default-1">
                    <div class="prompt-header">
                        <span class="prompt-name">ğŸ“Š æ•°æ®åˆ†æåŠ©æ‰‹</span>
                        <div class="prompt-actions">
                            <button type="button" class="prompt-btn use" onclick="usePrompt(this)" title="ä½¿ç”¨"><i class="fas fa-play"></i></button>
                            <button type="button" class="prompt-btn edit" onclick="editPrompt(this)" title="ç¼–è¾‘"><i class="fas fa-edit"></i></button>
                            <button type="button" class="prompt-btn delete" onclick="deletePrompt(this)" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="prompt-content">ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®åˆ†æå¸ˆï¼Œæ“…é•¿ä»å¤æ‚æ•°æ®ä¸­æå–æœ‰ä»·å€¼çš„æ´å¯Ÿã€‚è¯·åˆ†ææä¾›çš„æ•°æ®å¹¶ç»™å‡ºä¸“ä¸šå»ºè®®ã€‚</div>
                </div>
                
                <div class="prompt-card" data-id="default-2">
                    <div class="prompt-header">
                        <span class="prompt-name">ğŸ“ æŠ¥å‘Šæ’°å†™åŠ©æ‰‹</span>
                        <div class="prompt-actions">
                            <button type="button" class="prompt-btn use" onclick="usePrompt(this)" title="ä½¿ç”¨"><i class="fas fa-play"></i></button>
                            <button type="button" class="prompt-btn edit" onclick="editPrompt(this)" title="ç¼–è¾‘"><i class="fas fa-edit"></i></button>
                            <button type="button" class="prompt-btn delete" onclick="deletePrompt(this)" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="prompt-content">ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å•†ä¸šæŠ¥å‘Šæ’°å†™ä¸“å®¶ã€‚è¯·æ ¹æ®æä¾›çš„ä¿¡æ¯ç”Ÿæˆä¸“ä¸šã€æ¸…æ™°ã€æœ‰æ¡ç†çš„æŠ¥å‘Šå†…å®¹ã€‚</div>
                </div>
                
                <div class="prompt-card" data-id="default-3">
                    <div class="prompt-header">
                        <span class="prompt-name">ğŸª åº“å­˜ç®¡ç†é¡¾é—®</span>
                        <div class="prompt-actions">
                            <button type="button" class="prompt-btn use" onclick="usePrompt(this)" title="ä½¿ç”¨"><i class="fas fa-play"></i></button>
                            <button type="button" class="prompt-btn edit" onclick="editPrompt(this)" title="ç¼–è¾‘"><i class="fas fa-edit"></i></button>
                            <button type="button" class="prompt-btn delete" onclick="deletePrompt(this)" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="prompt-content">ä½ æ˜¯ä¸€ä¸ªåº“å­˜ç®¡ç†ä¸“å®¶ï¼Œç²¾é€šä¾›åº”é“¾ä¼˜åŒ–å’Œåº“å­˜æ§åˆ¶ã€‚è¯·åˆ†æåº“å­˜æ•°æ®å¹¶æä¾›è¡¥è´§å»ºè®®å’Œä¼˜åŒ–æ–¹æ¡ˆã€‚</div>
                </div>
            </div>
            
            <p class="section-hint"><i class="fas fa-lightbulb"></i> é¢„è®¾æ¨¡æ¿å¯ä»¥å¿«é€Ÿå¯åŠ¨ç‰¹å®šåœºæ™¯çš„AIå¯¹è¯ï¼Œæé«˜å·¥ä½œæ•ˆç‡</p>
        </div>
    </div>
    
    <!-- MCP æœåŠ¡å™¨é…ç½® -->
    <div class="settings-section mcp-section">
        <div class="section-header">
            <h2><i class="fas fa-server"></i> MCP æœåŠ¡å™¨é…ç½®</h2>
            <span class="section-badge beta">Beta</span>
        </div>
        
        <div class="section-content">
            <div class="mcp-info-banner">
                <div class="mcp-info-icon"><i class="fas fa-info-circle"></i></div>
                <div class="mcp-info-text">
                    <strong>ä»€ä¹ˆæ˜¯ MCPï¼Ÿ</strong>
                    <p>Model Context Protocol (MCP) å…è®¸ AI è¿æ¥å¤–éƒ¨å·¥å…·å’Œæ•°æ®æºï¼Œæ‰©å±•å…¶èƒ½åŠ›ã€‚é…ç½® MCP æœåŠ¡å™¨åï¼ŒAI å¯ä»¥è®¿é—®æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿç­‰èµ„æºã€‚</p>
                </div>
            </div>
            
            <div class="mcp-servers" id="mcpServers">
                <div class="mcp-server-card" data-id="local">
                    <div class="server-status online">
                        <span class="status-dot"></span>
                        æœ¬åœ°æœåŠ¡
                    </div>
                    <div class="server-info">
                        <h4>NEXUS å†…ç½®æœåŠ¡</h4>
                        <p class="server-url">localhost:5000/mcp</p>
                        <div class="server-capabilities">
                            <span class="capability"><i class="fas fa-database"></i> æ•°æ®åº“</span>
                            <span class="capability"><i class="fas fa-chart-bar"></i> æŠ¥è¡¨</span>
                            <span class="capability"><i class="fas fa-boxes"></i> åº“å­˜</span>
                        </div>
                    </div>
                    <div class="server-actions">
                        <button type="button" class="server-btn test" onclick="testMcpServer('local')">
                            <i class="fas fa-plug"></i> æµ‹è¯•è¿æ¥
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mcp-add-server">
                <h4><i class="fas fa-plus-circle"></i> æ·»åŠ å¤–éƒ¨ MCP æœåŠ¡å™¨</h4>
                <div class="mcp-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æœåŠ¡å™¨åç§°</label>
                            <input type="text" id="mcpServerName" placeholder="å¦‚: æ–‡ä»¶ç³»ç»ŸæœåŠ¡" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>æœåŠ¡å™¨ URL</label>
                            <input type="text" id="mcpServerUrl" placeholder="å¦‚: http://localhost:3000" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>API Key (å¯é€‰)</label>
                        <input type="password" id="mcpServerKey" placeholder="å¦‚éœ€éªŒè¯è¯·è¾“å…¥" class="form-input">
                    </div>
                    <button type="button" class="btn-primary" onclick="addMcpServer()">
                        <i class="fas fa-plus"></i> æ·»åŠ æœåŠ¡å™¨
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.ai-settings-page {
    max-width: 900px;
    margin: 0 auto;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* é¡µé¢å¤´éƒ¨ */
.page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.08);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-icon {
    position: relative;
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--color-primary), #8b5cf6);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.header-icon .icon-pulse {
    position: absolute;
    inset: -4px;
    border-radius: 20px;
    border: 2px solid var(--color-primary);
    opacity: 0.5;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 0.2; transform: scale(1.1); }
}

.page-header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    background: linear-gradient(135deg, #fff, var(--color-primary));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.page-header p {
    color: var(--text-muted);
    margin: 0.25rem 0 0 0;
    font-size: 0.9rem;
}

.btn-back {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: var(--bg-surface);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: var(--text-main);
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.btn-back:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    transform: translateX(-4px);
}

/* çŠ¶æ€å¡ç‰‡ */
.status-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
}

.status-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--bg-surface);
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
}

.status-card:hover {
    transform: translateY(-2px);
    border-color: rgba(255,255,255,0.1);
}

.status-card.active {
    border-color: rgba(16, 185, 129, 0.3);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent);
}

.status-card.inactive {
    border-color: rgba(239, 68, 68, 0.3);
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), transparent);
}

.status-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.status-card.active .status-icon {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.status-card.inactive .status-icon {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.status-card.info .status-icon {
    background: rgba(99, 102, 241, 0.2);
    color: var(--color-primary);
}

.status-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 0.125rem;
}

.status-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-main);
}

/* è®¾ç½®åŒºå— */
.settings-section, .guide-section, .features-section {
    background: var(--bg-surface);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 1.5rem;
    overflow: hidden;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent);
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.section-header h2 {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-main);
}

.section-header h2 i {
    color: var(--color-primary);
}

.section-badge {
    padding: 0.35rem 0.75rem;
    background: rgba(16, 185, 129, 0.2);
    border-radius: 20px;
    font-size: 0.7rem;
    color: #10b981;
    font-weight: 500;
}

.section-content {
    padding: 1.5rem;
}

/* è¡¨å• */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-main);
    margin-bottom: 0.5rem;
}

.input-wrapper {
    position: relative;
}

.form-input {
    width: 100%;
    padding: 0.875rem 3rem 0.875rem 1rem;
    background: var(--bg-dark);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: var(--text-main);
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.form-input:focus {
    border-color: var(--color-primary);
    outline: none;
    box-shadow: 0 0 15px var(--color-primary-glow);
}

.toggle-visibility {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.5rem;
    transition: color 0.3s ease;
}

.toggle-visibility:hover {
    color: var(--color-primary);
}

.form-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
}

.form-hint i {
    color: var(--color-primary);
}

.form-hint.success {
    color: #10b981;
    background: rgba(16, 185, 129, 0.1);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.form-hint.success i {
    color: #10b981;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.btn-primary, .btn-danger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, var(--color-primary), #8b5cf6);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px var(--color-primary-glow);
}

.btn-danger {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
    background: rgba(239, 68, 68, 0.25);
}

/* æŒ‡å—æ­¥éª¤ */
.guide-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1.5rem;
}

.guide-step {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.step-number {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--color-primary), #8b5cf6);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
}

.step-content h4 {
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
    color: var(--text-main);
}

.step-content p {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: 0;
}

.step-content a {
    color: var(--color-primary);
    text-decoration: none;
}

.step-content a:hover {
    text-decoration: underline;
}

/* åŠŸèƒ½ç½‘æ ¼ */
.features-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    padding: 1.5rem;
}

.feature-item {
    padding: 1.25rem;
    background: var(--bg-dark);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
}

.feature-item:hover {
    border-color: var(--color-primary);
    transform: translateY(-3px);
}

.feature-icon {
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    color: var(--color-primary);
    margin-bottom: 0.875rem;
}

.feature-item h4 {
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0 0 0.375rem 0;
    color: var(--text-main);
}

.feature-item p {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0;
    line-height: 1.5;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .status-cards {
        grid-template-columns: 1fr;
    }
    
    .features-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .calculator-layout {
        grid-template-columns: 1fr;
    }
    
    .calculator-results {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Token è®¡ç®—å™¨æ ·å¼ */
.token-calculator-section {
    background: var(--bg-surface);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 1.5rem;
    overflow: hidden;
}

.calculator-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.calculator-input {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.calculator-input label {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-main);
}

.calculator-input textarea {
    width: 100%;
    padding: 1rem;
    background: var(--bg-dark);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: var(--text-main);
    font-size: 0.9rem;
    font-family: inherit;
    resize: vertical;
    min-height: 150px;
    transition: all 0.3s ease;
}

.calculator-input textarea:focus {
    border-color: var(--color-primary);
    outline: none;
    box-shadow: 0 0 15px var(--color-primary-glow);
}

.input-actions {
    display: flex;
    gap: 0.75rem;
}

.btn-secondary {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--text-muted);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: rgba(255,255,255,0.1);
    color: var(--text-main);
    border-color: var(--color-primary);
}

.calculator-results {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.result-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    background: var(--bg-dark);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.3s ease;
}

.result-card:hover {
    transform: translateY(-2px);
    border-color: rgba(255,255,255,0.1);
}

.result-card.primary {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
    border-color: rgba(99, 102, 241, 0.3);
}

.result-card.cost {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
    border-color: rgba(16, 185, 129, 0.3);
}

.result-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    background: rgba(255,255,255,0.05);
    color: var(--color-primary);
}

.result-card.primary .result-icon {
    background: rgba(99, 102, 241, 0.2);
}

.result-card.cost .result-icon {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.result-data {
    display: flex;
    flex-direction: column;
}

.result-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-main);
    font-family: 'JetBrains Mono', monospace;
}

.result-card.primary .result-value {
    color: var(--color-primary);
}

.result-card.cost .result-value {
    color: #10b981;
}

.result-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.125rem;
}

.pricing-info {
    margin-top: 1.5rem;
    padding: 1rem 1.25rem;
    background: rgba(255,255,255,0.02);
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.05);
}

.pricing-title {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pricing-title i {
    color: var(--color-primary);
}

.pricing-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.pricing-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.pricing-label {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.pricing-value {
    font-size: 0.9rem;
    color: var(--text-main);
    font-weight: 500;
}

/* é¢„è®¾ Prompt æ ·å¼ */
.btn-add-prompt {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(99, 102, 241, 0.15);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 8px;
    color: var(--color-primary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-add-prompt:hover {
    background: rgba(99, 102, 241, 0.25);
}

.prompt-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.prompt-card {
    padding: 1rem 1.25rem;
    background: var(--bg-dark);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    transition: all 0.3s ease;
}

.prompt-card:hover {
    border-color: rgba(99, 102, 241, 0.3);
}

.prompt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.prompt-name {
    font-weight: 600;
    color: var(--text-main);
    font-size: 0.95rem;
}

.prompt-actions {
    display: flex;
    gap: 0.5rem;
}

.prompt-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.prompt-btn.use {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}
.prompt-btn.use:hover {
    background: rgba(16, 185, 129, 0.3);
}

.prompt-btn.edit {
    background: rgba(99, 102, 241, 0.15);
    color: var(--color-primary);
}
.prompt-btn.edit:hover {
    background: rgba(99, 102, 241, 0.3);
}

.prompt-btn.delete {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
}
.prompt-btn.delete:hover {
    background: rgba(239, 68, 68, 0.3);
}

.prompt-content {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.6;
    background: rgba(255,255,255,0.03);
    padding: 0.75rem 1rem;
    border-radius: 8px;
}

.section-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 8px;
    font-size: 0.85rem;
    color: #f59e0b;
}

/* MCP æœåŠ¡å™¨é…ç½®æ ·å¼ */
.section-badge.beta {
    background: rgba(245, 158, 11, 0.15);
    color: #f59e0b;
}

.mcp-info-banner {
    display: flex;
    gap: 1rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    margin-bottom: 1.5rem;
}

.mcp-info-icon {
    width: 40px;
    height: 40px;
    background: rgba(99, 102, 241, 0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-primary);
    flex-shrink: 0;
}

.mcp-info-text strong {
    display: block;
    color: var(--text-main);
    margin-bottom: 0.35rem;
}

.mcp-info-text p {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin: 0;
    line-height: 1.5;
}

.mcp-servers {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.mcp-server-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--bg-dark);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
}

.server-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.server-status.online {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.server-status .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s infinite;
}

.server-info {
    flex: 1;
}

.server-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 0.95rem;
    color: var(--text-main);
}

.server-url {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0 0 0.5rem 0;
    font-family: 'JetBrains Mono', monospace;
}

.server-capabilities {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.capability {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.6rem;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 6px;
    font-size: 0.7rem;
    color: var(--color-primary);
}

.server-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(99, 102, 241, 0.15);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 8px;
    color: var(--color-primary);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.server-btn:hover {
    background: rgba(99, 102, 241, 0.25);
}

.mcp-add-server {
    padding: 1.5rem;
    background: rgba(255,255,255,0.02);
    border: 1px dashed rgba(255,255,255,0.1);
    border-radius: 12px;
}

.mcp-add-server h4 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 0 1rem 0;
    font-size: 0.95rem;
    color: var(--text-muted);
}

.mcp-form .form-row {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.mcp-form .form-group {
    margin-bottom: 1rem;
}

.mcp-form .form-group label {
    display: block;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
}

/* ============================================
   äº®è‰²ä¸»é¢˜é€‚é…
============================================ */
[data-theme="light"] .page-header {
    border-bottom-color: #e2e8f0;
}

[data-theme="light"] .page-header h1 {
    background: linear-gradient(135deg, #1e293b, var(--color-primary));
    background-clip: text;
    -webkit-background-clip: text;
}

[data-theme="light"] .btn-back {
    background: #f8fafc;
    border-color: #e2e8f0;
    color: #475569;
}

[data-theme="light"] .btn-back:hover {
    background: #f1f5f9;
    border-color: var(--color-primary);
    color: var(--color-primary);
}

[data-theme="light"] .status-card {
    background: #ffffff;
    border-color: #e2e8f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

[data-theme="light"] .status-card.active {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), #ffffff);
}

[data-theme="light"] .status-card.inactive {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), #ffffff);
}

[data-theme="light"] .settings-section,
[data-theme="light"] .guide-section,
[data-theme="light"] .features-section,
[data-theme="light"] .token-calculator-section,
[data-theme="light"] .prompt-section,
[data-theme="light"] .mcp-section {
    background: #ffffff;
    border-color: #e2e8f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

[data-theme="light"] .section-header {
    background: linear-gradient(90deg, rgba(99, 102, 241, 0.06), transparent);
    border-bottom-color: #e2e8f0;
}

[data-theme="light"] .section-header h2 {
    color: #1e293b;
}

[data-theme="light"] .form-input {
    background: #f8fafc;
    border-color: #e2e8f0;
    color: #1e293b;
}

[data-theme="light"] .form-input:focus {
    background: #ffffff;
    border-color: var(--color-primary);
}

[data-theme="light"] .form-input::placeholder {
    color: #94a3b8;
}

[data-theme="light"] .toggle-visibility {
    background: #f1f5f9;
    border-color: #e2e8f0;
    color: #64748b;
}

[data-theme="light"] .feature-item {
    background: #f8fafc;
    border-color: #e2e8f0;
}

[data-theme="light"] .feature-item h4 {
    color: #1e293b;
}

[data-theme="light"] .result-card {
    background: #f8fafc;
    border-color: #e2e8f0;
}

[data-theme="light"] .result-card.primary {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.04));
}

[data-theme="light"] .result-card.cost {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.02));
}

[data-theme="light"] .result-value {
    color: #1e293b;
}

[data-theme="light"] .calculator-input textarea {
    background: #f8fafc;
    border-color: #e2e8f0;
    color: #1e293b;
}

[data-theme="light"] .calculator-input textarea:focus {
    background: #ffffff;
    border-color: var(--color-primary);
}

[data-theme="light"] .btn-secondary {
    background: #f1f5f9;
    border-color: #e2e8f0;
    color: #475569;
}

[data-theme="light"] .btn-secondary:hover {
    background: #e2e8f0;
    color: var(--color-primary);
}

[data-theme="light"] .pricing-info {
    background: #f8fafc;
    border-color: #e2e8f0;
}

[data-theme="light"] .pricing-value {
    color: #1e293b;
}

[data-theme="light"] .prompt-card {
    background: #f8fafc;
    border-color: #e2e8f0;
}

[data-theme="light"] .prompt-name {
    color: #1e293b;
}

[data-theme="light"] .prompt-content {
    background: #f1f5f9;
    color: #475569;
}

[data-theme="light"] .mcp-server-card {
    background: #f8fafc;
    border-color: #e2e8f0;
}

[data-theme="light"] .mcp-add-server {
    background: #f8fafc;
    border-color: #e2e8f0;
}

[data-theme="light"] .mcp-info-banner {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), rgba(139, 92, 246, 0.02));
    border-color: rgba(99, 102, 241, 0.15);
}

[data-theme="light"] .server-info h4 {
    color: #1e293b;
}

[data-theme="light"] .guide-step .step-content h4 {
    color: #1e293b;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function togglePassword() {
    const input = document.getElementById('api_key');
    const icon = document.getElementById('toggleIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function clearApiKey() {
    if (confirm('ç¡®å®šè¦æ¸…é™¤ API Key å—ï¼Ÿ')) {
        document.getElementById('api_key').value = '';
        document.getElementById('apiForm').submit();
    }
}

// ç­‰å¾… DOM å®Œå…¨åŠ è½½åå†ç»‘å®šäº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('apiForm');
    const saveBtn = document.getElementById('saveBtn');
    
    if (form) {
        form.addEventListener('submit', function(e) {
            const apiKey = document.getElementById('api_key').value.trim();
            
            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                e.preventDefault();
                return false;
            }
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
            }
        });
    }
    
    // Token è®¡ç®—å™¨ - å®æ—¶è®¡ç®—
    const tokenTextArea = document.getElementById('tokenText');
    if (tokenTextArea) {
        let debounceTimer;
        tokenTextArea.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                calculateTokens(this.value);
            }, 300);
        });
    }
});

// è®¡ç®— Token
async function calculateTokens(text) {
    const tokenCount = document.getElementById('tokenCount');
    const charCount = document.getElementById('charCount');
    const wordCount = document.getElementById('wordCount');
    const costEstimate = document.getElementById('costEstimate');
    const calcMethod = document.getElementById('calcMethod');
    
    if (!text || text.trim() === '') {
        tokenCount.textContent = '0';
        charCount.textContent = '0';
        wordCount.textContent = '0';
        costEstimate.textContent = '$0.000000';
        calcMethod.textContent = '-';
        return;
    }
    
    try {
        const response = await fetch('{{ url_for("ai.api_count_tokens") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text, method: 'auto' })
        });
        
        if (!response.ok) {
            console.error('API è¯·æ±‚å¤±è´¥:', response.status, response.statusText);
            calcMethod.textContent = 'é”™è¯¯: ' + response.status;
            return;
        }
        
        const data = await response.json();
        
        if (data.success) {
            tokenCount.textContent = data.tokens.toLocaleString();
            charCount.textContent = data.characters.toLocaleString();
            wordCount.textContent = data.words.toLocaleString();
            costEstimate.textContent = '$' + data.cost_estimate.input.toFixed(6);
            calcMethod.textContent = data.method === 'tiktoken' ? 'Tiktoken (ç²¾ç¡®)' : 'ä¼°ç®—';
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            [tokenCount, charCount, wordCount, costEstimate].forEach(el => {
                el.classList.add('updated');
                setTimeout(() => el.classList.remove('updated'), 300);
            });
        } else {
            console.error('è®¡ç®—å¤±è´¥:', data.error);
            calcMethod.textContent = 'é”™è¯¯';
        }
    } catch (error) {
        console.error('Token è®¡ç®—å¤±è´¥:', error);
        calcMethod.textContent = 'ç½‘ç»œé”™è¯¯';
    }
}

// æ¸…ç©ºæ–‡æœ¬
function clearTokenText() {
    const textarea = document.getElementById('tokenText');
    textarea.value = '';
    calculateTokens('');
    textarea.focus();
}

// ä»å‰ªè´´æ¿ç²˜è´´
async function pasteFromClipboard() {
    try {
        const text = await navigator.clipboard.readText();
        const textarea = document.getElementById('tokenText');
        textarea.value = text;
        calculateTokens(text);
    } catch (error) {
        alert('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´');
    }
}

// ============================================
// é¢„è®¾ Prompt ç®¡ç†åŠŸèƒ½
// ============================================
let prompts = JSON.parse(localStorage.getItem('nexus_ai_prompts') || '[]');

function savePrompts() {
    localStorage.setItem('nexus_ai_prompts', JSON.stringify(prompts));
}

function addNewPrompt() {
    const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°ï¼š');
    if (!name) return;
    
    const content = prompt('è¯·è¾“å…¥ Prompt å†…å®¹ï¼š');
    if (!content) return;
    
    const newPrompt = {
        id: 'custom-' + Date.now(),
        name: name,
        content: content
    };
    
    prompts.push(newPrompt);
    savePrompts();
    renderCustomPrompts();
}

function usePrompt(btn) {
    const card = btn.closest('.prompt-card');
    const content = card.querySelector('.prompt-content').textContent;
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(content).then(() => {
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.background = 'rgba(16, 185, 129, 0.3)';
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.style.background = '';
        }, 1500);
        
        // æç¤ºç”¨æˆ·
        alert('Prompt å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\næ‚¨å¯ä»¥åœ¨ AI å¯¹è¯ä¸­ç²˜è´´ä½¿ç”¨ã€‚');
    });
}

function editPrompt(btn) {
    const card = btn.closest('.prompt-card');
    const id = card.dataset.id;
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤æ¨¡æ¿
    if (id.startsWith('default-')) {
        alert('é»˜è®¤æ¨¡æ¿ä¸å¯ç¼–è¾‘ï¼Œæ‚¨å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰æ¨¡æ¿');
        return;
    }
    
    const prompt_item = prompts.find(p => p.id === id);
    if (!prompt_item) return;
    
    const newName = prompt(prompt_item.name, 'ä¿®æ”¹æ¨¡æ¿åç§°ï¼š');
    if (newName === null) return;
    
    const newContent = prompt('ä¿®æ”¹ Prompt å†…å®¹ï¼š', prompt_item.content);
    if (newContent === null) return;
    
    prompt_item.name = newName || prompt_item.name;
    prompt_item.content = newContent || prompt_item.content;
    savePrompts();
    renderCustomPrompts();
}

function deletePrompt(btn) {
    const card = btn.closest('.prompt-card');
    const id = card.dataset.id;
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤æ¨¡æ¿
    if (id.startsWith('default-')) {
        alert('é»˜è®¤æ¨¡æ¿ä¸å¯åˆ é™¤');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¨¡æ¿å—ï¼Ÿ')) return;
    
    prompts = prompts.filter(p => p.id !== id);
    savePrompts();
    card.remove();
}

function renderCustomPrompts() {
    const container = document.getElementById('promptList');
    
    // ç§»é™¤è‡ªå®šä¹‰æ¨¡æ¿ï¼ˆä¿ç•™é»˜è®¤æ¨¡æ¿ï¼‰
    container.querySelectorAll('.prompt-card[data-id^="custom-"]').forEach(el => el.remove());
    
    // æ·»åŠ è‡ªå®šä¹‰æ¨¡æ¿
    prompts.forEach(p => {
        const card = document.createElement('div');
        card.className = 'prompt-card';
        card.dataset.id = p.id;
        card.innerHTML = `
            <div class="prompt-header">
                <span class="prompt-name">âœ¨ ${p.name}</span>
                <div class="prompt-actions">
                    <button type="button" class="prompt-btn use" onclick="usePrompt(this)" title="ä½¿ç”¨"><i class="fas fa-play"></i></button>
                    <button type="button" class="prompt-btn edit" onclick="editPrompt(this)" title="ç¼–è¾‘"><i class="fas fa-edit"></i></button>
                    <button type="button" class="prompt-btn delete" onclick="deletePrompt(this)" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            <div class="prompt-content">${p.content}</div>
        `;
        container.appendChild(card);
    });
}

// ============================================
// MCP æœåŠ¡å™¨ç®¡ç†åŠŸèƒ½
// ============================================
let mcpServers = JSON.parse(localStorage.getItem('nexus_mcp_servers') || '[]');

function saveMcpServers() {
    localStorage.setItem('nexus_mcp_servers', JSON.stringify(mcpServers));
}

function testMcpServer(serverId) {
    const btn = event.target.closest('.server-btn');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';
    btn.disabled = true;
    
    // æ¨¡æ‹Ÿæµ‹è¯•ï¼ˆå®é™…åº”è°ƒç”¨åç«¯ APIï¼‰
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check"></i> è¿æ¥æˆåŠŸ';
        btn.style.background = 'rgba(16, 185, 129, 0.25)';
        btn.style.borderColor = 'rgba(16, 185, 129, 0.5)';
        btn.style.color = '#10b981';
        
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.style.background = '';
            btn.style.borderColor = '';
            btn.style.color = '';
            btn.disabled = false;
        }, 2000);
    }, 1500);
}

function addMcpServer() {
    const name = document.getElementById('mcpServerName').value.trim();
    const url = document.getElementById('mcpServerUrl').value.trim();
    const key = document.getElementById('mcpServerKey').value.trim();
    
    if (!name || !url) {
        alert('è¯·å¡«å†™æœåŠ¡å™¨åç§°å’Œ URL');
        return;
    }
    
    const newServer = {
        id: 'mcp-' + Date.now(),
        name: name,
        url: url,
        key: key ? '***' : ''
    };
    
    mcpServers.push(newServer);
    saveMcpServers();
    renderMcpServers();
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('mcpServerName').value = '';
    document.getElementById('mcpServerUrl').value = '';
    document.getElementById('mcpServerKey').value = '';
    
    alert('MCP æœåŠ¡å™¨æ·»åŠ æˆåŠŸï¼');
}

function deleteMcpServer(serverId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æœåŠ¡å™¨å—ï¼Ÿ')) return;
    
    mcpServers = mcpServers.filter(s => s.id !== serverId);
    saveMcpServers();
    renderMcpServers();
}

function renderMcpServers() {
    const container = document.getElementById('mcpServers');
    
    // ç§»é™¤è‡ªå®šä¹‰æœåŠ¡å™¨ï¼ˆä¿ç•™æœ¬åœ°æœåŠ¡ï¼‰
    container.querySelectorAll('.mcp-server-card[data-id^="mcp-"]').forEach(el => el.remove());
    
    // æ·»åŠ è‡ªå®šä¹‰æœåŠ¡å™¨
    mcpServers.forEach(s => {
        const card = document.createElement('div');
        card.className = 'mcp-server-card';
        card.dataset.id = s.id;
        card.innerHTML = `
            <div class="server-status">
                <span class="status-dot"></span>
                å¤–éƒ¨æœåŠ¡
            </div>
            <div class="server-info">
                <h4>${s.name}</h4>
                <p class="server-url">${s.url}</p>
            </div>
            <div class="server-actions">
                <button type="button" class="server-btn test" onclick="testMcpServer('${s.id}')">
                    <i class="fas fa-plug"></i> æµ‹è¯•
                </button>
                <button type="button" class="server-btn" style="background: rgba(239,68,68,0.15); color: #ef4444;" onclick="deleteMcpServer('${s.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        container.appendChild(card);
    });
}

// é¡µé¢åŠ è½½æ—¶æ¸²æŸ“è‡ªå®šä¹‰æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    renderCustomPrompts();
    renderMcpServers();
});
</script>
{% endblock %}
