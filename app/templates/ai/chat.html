{% extends "layouts/base.html" %}

{% block title %}NEXUS AI æ™ºèƒ½åŠ©æ‰‹{% endblock %}
{% block breadcrumb %}AI æ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block styles %}
<style>
/* ============================================
   NEXUS AI æ™ºèƒ½åŠ©æ‰‹
   ============================================ */

.ai-chat-container {
    height: calc(100vh - 120px);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 0;
    position: relative;
}

/* åŠ¨æ€èƒŒæ™¯ */
.ai-chat-container::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
        radial-gradient(circle at 15% 25%, rgba(99, 102, 241, 0.12), transparent 35%),
        radial-gradient(circle at 85% 75%, rgba(139, 92, 246, 0.1), transparent 40%),
        radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.06), transparent 50%);
    pointer-events: none;
    z-index: 0;
    animation: glowPulse 8s ease-in-out infinite;
}

@keyframes glowPulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

/* é¡µé¢å¤´éƒ¨ */
.ai-page-header {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.75rem;
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(30, 41, 59, 0.85));
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(99, 102, 241, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 60px rgba(99, 102, 241, 0.1);
    overflow: hidden;
}

.ai-page-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.6), rgba(139, 92, 246, 0.6), transparent);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 1.25rem;
}

/* AI Logo åŠ¨ç”» */
.ai-logo {
    position: relative;
    width: 60px;
    height: 60px;
}

.logo-core {
    position: absolute;
    inset: 10px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6, #06b6d4);
    background-size: 200% 200%;
    animation: gradientShift 3s ease-in-out infinite;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
    z-index: 3;
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.1);
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.logo-orbit {
    position: absolute;
    inset: 0;
    border: 2px solid transparent;
    border-top-color: rgba(99, 102, 241, 0.6);
    border-right-color: rgba(139, 92, 246, 0.4);
    border-radius: 50%;
    animation: orbit-spin 4s linear infinite;
}

.logo-orbit::before {
    content: '';
    position: absolute;
    top: -5px;
    left: 50%;
    width: 10px;
    height: 10px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 50%;
    transform: translateX(-50%);
    box-shadow: 0 0 15px rgba(99, 102, 241, 0.8);
}

.orbit-2 {
    inset: -8px;
    animation-duration: 6s;
    animation-direction: reverse;
    border-top-color: rgba(6, 182, 212, 0.5);
}

@keyframes orbit-spin {
    to { transform: rotate(360deg); }
}

.header-info h1 {
    font-size: 1.5rem;
    font-weight: 800;
    margin: 0;
    background: linear-gradient(135deg, #fff 0%, #a5b4fc 50%, #22d3ee 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.header-info p {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: 0.35rem 0 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.75rem;
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 20px;
    font-size: 0.75rem;
    color: #10b981;
}

.status-dot {
    width: 8px;
    height: 8px;
    background: #10b981;
    border-radius: 50%;
    animation: pulse-glow 2s ease-in-out infinite;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
}

@keyframes pulse-glow {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(0.9); }
}

.header-actions {
    display: flex;
    gap: 0.6rem;
}

.action-btn {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    position: relative;
    overflow: hidden;
}

.action-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--color-primary), #8b5cf6);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.action-btn i { position: relative; z-index: 1; }

.action-btn:hover {
    border-color: var(--color-primary);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
}

.action-btn:hover::before { opacity: 1; }

/* API è­¦å‘Šæ¨ªå¹… */
.api-warning-banner {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border-radius: 14px;
    animation: slideDown 0.5s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.api-warning-banner.info {
    background: linear-gradient(135deg, rgba(6, 182, 212, 0.12), rgba(99, 102, 241, 0.08));
    border: 1px solid rgba(6, 182, 212, 0.25);
}

.api-warning-banner.warning {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.12), rgba(245, 158, 11, 0.08));
    border: 1px solid rgba(251, 191, 36, 0.3);
}

.api-warning-banner > i { font-size: 1.5rem; }
.api-warning-banner.info > i { color: #06b6d4; }
.api-warning-banner.warning > i { color: #fbbf24; }

.warning-content strong {
    color: var(--text-main);
    display: block;
    margin-bottom: 0.25rem;
}

.warning-content p {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: 0;
}

.warning-content a {
    color: var(--color-primary);
    font-weight: 500;
}

/* èŠå¤©å¸ƒå±€ */
.chat-layout {
    position: relative;
    z-index: 1;
    flex: 1;
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 1rem;
    min-height: 0;
}

/* ä¼šè¯é¢æ¿ */
.sessions-panel {
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.85), rgba(30, 41, 59, 0.9));
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent);
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}

.panel-header span {
    font-weight: 600;
    color: var(--text-main);
    display: flex;
    align-items: center;
    gap: 0.6rem;
}

.panel-header span i { color: var(--color-primary); }

.new-chat-btn {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
}

.new-chat-btn:hover {
    transform: scale(1.1) rotate(90deg);
}

.sessions-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
}

.session-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0.5rem;
    border: 1px solid transparent;
}

.session-item:hover {
    background: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.2);
    transform: translateX(5px);
}

.session-item.active {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15));
    border: 1px solid rgba(99, 102, 241, 0.4);
}

.session-item i { color: var(--color-primary); }

.session-info { flex: 1; min-width: 0; }

.session-name {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-main);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.session-time {
    font-size: 0.7rem;
    color: var(--text-muted);
}

.session-delete {
    opacity: 0;
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-size: 0.75rem;
}

.session-item:hover .session-delete {
    opacity: 1;
}

.session-delete:hover {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

/* å¿«æ·åŠŸèƒ½ */
.quick-features {
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
    background: linear-gradient(0deg, rgba(99, 102, 241, 0.05), transparent);
}

.feature-title {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.feature-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, rgba(99, 102, 241, 0.3), transparent);
}

.feature-btn {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.7rem 1rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    color: var(--text-muted);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 0.5rem;
}

.feature-btn:hover {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
    border-color: rgba(99, 102, 241, 0.3);
    color: #a5b4fc;
    transform: translateX(5px);
}

.feature-btn i { width: 20px; text-align: center; color: var(--color-primary); }

/* ä¸»èŠå¤©åŒº */
.chat-main {
    background: linear-gradient(180deg, rgba(15, 23, 42, 0.7), rgba(30, 41, 59, 0.8));
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    position: relative;
}

.chat-main::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), rgba(139, 92, 246, 0.5), rgba(6, 182, 212, 0.5), transparent);
}

.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    scroll-behavior: smooth;
}

.messages-container::-webkit-scrollbar { width: 6px; }
.messages-container::-webkit-scrollbar-track { background: transparent; }
.messages-container::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 3px;
}

/* æ¬¢è¿ç•Œé¢ */
.welcome-screen {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 2rem;
}

.welcome-logo {
    position: relative;
    width: 140px;
    height: 140px;
    margin-bottom: 2.5rem;
}

.logo-sphere {
    position: absolute;
    inset: 25px;
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
    background-size: 200% 200%;
    animation: sphereGlow 4s ease-in-out infinite;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: white;
    z-index: 2;
    box-shadow: 0 0 50px rgba(99, 102, 241, 0.5), inset 0 0 30px rgba(255, 255, 255, 0.2);
}

@keyframes sphereGlow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.logo-rings { position: absolute; inset: 0; }

.ring {
    position: absolute;
    inset: 0;
    border: 2px solid rgba(99, 102, 241, 0.3);
    border-radius: 50%;
    animation: ring-pulse 3s ease-in-out infinite;
}

.ring-2 { inset: -15px; animation-delay: 0.4s; border-color: rgba(139, 92, 246, 0.25); }
.ring-3 { inset: -30px; animation-delay: 0.8s; border-color: rgba(6, 182, 212, 0.2); }

@keyframes ring-pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.05); opacity: 0.8; }
}

.welcome-screen h2 {
    font-size: 2rem;
    font-weight: 800;
    margin: 0 0 1rem;
    background: linear-gradient(135deg, #fff 0%, #a5b4fc 50%, #22d3ee 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.welcome-screen > p {
    font-size: 1.05rem;
    color: var(--text-muted);
    max-width: 500px;
    margin-bottom: 3rem;
    line-height: 1.7;
}

.suggestion-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    max-width: 580px;
}

.suggestion-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: left;
}

.suggestion-card:hover {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
    border-color: rgba(99, 102, 241, 0.4);
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
}

.suggestion-card i {
    font-size: 1.5rem;
    color: var(--color-primary);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(99, 102, 241, 0.15);
    border-radius: 12px;
    flex-shrink: 0;
}

.suggestion-card span {
    font-size: 0.95rem;
    color: var(--text-main);
    font-weight: 500;
}

/* æ¶ˆæ¯æ ·å¼ */
.message {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    animation: messageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes messageSlide {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-user { flex-direction: row-reverse; }

.msg-avatar {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 1.1rem;
}

.message-ai .msg-avatar {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
}

.message-user .msg-avatar {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15));
    color: var(--text-main);
    font-weight: 600;
    border: 2px solid rgba(99, 102, 241, 0.3);
}

.msg-content {
    max-width: 70%;
    padding: 1.25rem 1.5rem;
    border-radius: 18px;
    font-size: 0.95rem;
    line-height: 1.7;
    position: relative;
}

.message-ai .msg-content {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.85), rgba(22, 33, 52, 0.9));
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-top-left-radius: 4px;
    color: var(--text-main);
    backdrop-filter: blur(10px);
}

.message-user .msg-content {
    background: linear-gradient(135deg, #6366f1, #7c3aed);
    color: white;
    border-top-right-radius: 4px;
    border: none;
}

.msg-content pre {
    background: rgba(0, 0, 0, 0.35);
    padding: 1rem;
    border-radius: 10px;
    overflow-x: auto;
    margin: 0.75rem 0;
    border: 1px solid rgba(99, 102, 241, 0.15);
}

.msg-content code { font-family: 'JetBrains Mono', 'Fira Code', monospace; }

.msg-time {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 0.6rem;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.message-user .msg-time {
    justify-content: flex-end;
    color: rgba(255, 255, 255, 0.7);
}

/* æ‰“å­—æŒ‡ç¤ºå™¨ */
.typing-indicator { display: flex; gap: 1rem; margin-bottom: 1.5rem; }

.typing-dots {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 1.25rem 1.75rem;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    border-top-left-radius: 6px;
}

.typing-dot {
    width: 10px;
    height: 10px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border-radius: 50%;
    animation: typingBounce 1.4s ease-in-out infinite;
    box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
}

.typing-dot:nth-child(2) { animation-delay: 0.15s; }
.typing-dot:nth-child(3) { animation-delay: 0.3s; }

@keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}

/* è¾“å…¥åŒºåŸŸ */
.input-container {
    display: flex;
    gap: 1rem;
    padding: 1.25rem 1.5rem 1.75rem;
    background: linear-gradient(180deg, transparent, rgba(15, 23, 42, 0.6) 30%);
}

.input-wrapper {
    flex: 1;
    position: relative;
}

.input-wrapper textarea {
    width: 100%;
    min-height: 56px;
    max-height: 160px;
    padding: 1rem 1.25rem;
    padding-right: 140px;
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(99, 102, 241, 0.25);
    border-radius: 16px;
    color: var(--text-main);
    font-size: 0.95rem;
    font-family: inherit;
    resize: none;
    outline: none;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.input-wrapper textarea:focus {
    border-color: var(--color-primary);
    background: rgba(30, 41, 59, 0.8);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.input-wrapper textarea::placeholder { color: var(--text-muted); }

.input-tools {
    position: absolute;
    right: 14px;
    bottom: 14px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.context-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.4rem 0.75rem;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.context-toggle:hover { background: rgba(99, 102, 241, 0.2); }

.context-toggle input {
    width: 16px;
    height: 16px;
    accent-color: var(--color-primary);
}

.toggle-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
}

.send-btn {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border: none;
    border-radius: 16px;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
    position: relative;
    overflow: hidden;
}

.send-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, #8b5cf6, #06b6d4);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.send-btn i { position: relative; z-index: 1; }

.send-btn:hover:not(:disabled) {
    transform: scale(1.08);
    box-shadow: 0 8px 30px rgba(99, 102, 241, 0.5);
}

.send-btn:hover:not(:disabled)::before { opacity: 1; }

.send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* å“åº”å¼ */
@media (max-width: 1024px) {
    .chat-layout { grid-template-columns: 1fr; }
    .sessions-panel { display: none; }
}

@media (max-width: 640px) {
    .suggestion-cards { grid-template-columns: 1fr; }
    .msg-content { max-width: 85%; }
    .ai-page-header { flex-direction: column; gap: 1rem; text-align: center; }
    .header-left { flex-direction: column; }
}

/* äº®è‰²ä¸»é¢˜ */
[data-theme="light"] .ai-chat-container::before {
    background: radial-gradient(circle at 15% 25%, rgba(99, 102, 241, 0.08), transparent 35%);
}

[data-theme="light"] .ai-page-header,
[data-theme="light"] .sessions-panel,
[data-theme="light"] .chat-main {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(99, 102, 241, 0.15);
}

[data-theme="light"] .message-ai .msg-content {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(241, 245, 249, 0.98));
    border: 1px solid rgba(99, 102, 241, 0.1);
    color: #1e293b;
    backdrop-filter: blur(10px);
}

[data-theme="light"] .message-user .msg-content {
    background: linear-gradient(135deg, #6366f1, #7c3aed);
    border: none;
}

[data-theme="light"] .msg-content pre {
    background: rgba(30, 41, 59, 0.08);
    border-color: rgba(99, 102, 241, 0.1);
}

[data-theme="light"] .input-container {
    background: linear-gradient(180deg, transparent, rgba(248, 250, 252, 0.8) 30%);
}

[data-theme="light"] .input-wrapper textarea {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(99, 102, 241, 0.2);
    color: #1e293b;
}

[data-theme="light"] .input-wrapper textarea:focus {
    border-color: var(--color-primary);
    background: #fff;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.08);
}

[data-theme="light"] .input-wrapper textarea::placeholder {
    color: #94a3b8;
}

[data-theme="light"] .context-toggle {
    background: rgba(99, 102, 241, 0.08);
}

[data-theme="light"] .toggle-label {
    color: #475569;
}

[data-theme="light"] .suggestion-card {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(99, 102, 241, 0.12);
}

[data-theme="light"] .suggestion-card:hover {
    border-color: rgba(99, 102, 241, 0.3);
    background: #fff;
}

[data-theme="light"] .suggestion-card .sug-title {
    color: #1e293b;
}

[data-theme="light"] .suggestion-card .sug-desc {
    color: #64748b;
}

/* äº®è‰²ä¸»é¢˜ - å¤´éƒ¨åŒºåŸŸ */
[data-theme="light"] .ai-page-header {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 250, 252, 0.95));
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

[data-theme="light"] .ai-page-header::before {
    background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.4), rgba(139, 92, 246, 0.4), transparent);
}

[data-theme="light"] .header-info h1 {
    background: linear-gradient(135deg, #1e293b 0%, #6366f1 50%, #06b6d4 100%);
    background-clip: text;
    -webkit-background-clip: text;
}

[data-theme="light"] .header-info p {
    color: #64748b;
}

[data-theme="light"] .status-indicator {
    background: rgba(16, 185, 129, 0.12);
    border-color: rgba(16, 185, 129, 0.25);
}

[data-theme="light"] .action-btn {
    background: rgba(99, 102, 241, 0.08);
    border-color: rgba(99, 102, 241, 0.15);
    color: #64748b;
}

[data-theme="light"] .action-btn:hover {
    background: rgba(99, 102, 241, 0.15);
    border-color: rgba(99, 102, 241, 0.3);
    color: #6366f1;
}

/* äº®è‰²ä¸»é¢˜ - ä¼šè¯é¢æ¿ */
[data-theme="light"] .sessions-panel {
    background: rgba(255, 255, 255, 0.98);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}

[data-theme="light"] .session-item {
    background: #f8fafc;
    border-color: #e2e8f0;
}

[data-theme="light"] .session-item:hover,
[data-theme="light"] .session-item.active {
    background: rgba(99, 102, 241, 0.08);
    border-color: rgba(99, 102, 241, 0.25);
}

[data-theme="light"] .session-title {
    color: #1e293b;
}

[data-theme="light"] .session-time {
    color: #94a3b8;
}

/* äº®è‰²ä¸»é¢˜ - èŠå¤©ä¸»åŒºåŸŸ */
[data-theme="light"] .chat-main {
    background: rgba(255, 255, 255, 0.98);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
}

[data-theme="light"] .welcome-section h2 {
    color: #1e293b;
}

[data-theme="light"] .welcome-section p {
    color: #64748b;
}

/* äº®è‰²ä¸»é¢˜ - è­¦å‘Šæç¤º */
[data-theme="light"] .fallback-notice,
[data-theme="light"] .no-key-warning {
    background: rgba(245, 158, 11, 0.08);
    border-color: rgba(245, 158, 11, 0.2);
}

[data-theme="light"] .fallback-notice p,
[data-theme="light"] .no-key-warning p {
    color: #92400e;
}

[data-theme="light"] .fallback-notice a,
[data-theme="light"] .no-key-warning a {
    color: #d97706;
}

/* äº®è‰²ä¸»é¢˜ - å‘é€æŒ‰é’® */
[data-theme="light"] .send-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
}

[data-theme="light"] .send-btn:hover {
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
}

/* äº®è‰²ä¸»é¢˜ - æ¬¢è¿å±å¹• */
[data-theme="light"] .welcome-screen h2 {
    background: linear-gradient(135deg, #1e293b 0%, #6366f1 50%, #06b6d4 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

[data-theme="light"] .welcome-screen > p {
    color: #64748b;
}

[data-theme="light"] .typing-dots {
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(241, 245, 249, 0.98));
    border: 1px solid rgba(99, 102, 241, 0.12);
}

/* äº®è‰²ä¸»é¢˜ - æ–°å¯¹è¯/ä¼šè¯é¢æ¿ */
[data-theme="light"] .panel-header {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), transparent);
    border-bottom-color: rgba(99, 102, 241, 0.08);
}

[data-theme="light"] .panel-header span {
    color: #1e293b;
}

[data-theme="light"] .session-name {
    color: #1e293b;
}

[data-theme="light"] .new-chat-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
}

[data-theme="light"] .quick-features {
    background: linear-gradient(0deg, rgba(99, 102, 241, 0.04), transparent);
    border-top-color: rgba(99, 102, 241, 0.08);
}

[data-theme="light"] .feature-title {
    color: #64748b;
}

[data-theme="light"] .feature-btn {
    background: rgba(255, 255, 255, 0.8);
    border-color: rgba(99, 102, 241, 0.12);
    color: #475569;
}

[data-theme="light"] .feature-btn:hover {
    background: rgba(99, 102, 241, 0.08);
    border-color: rgba(99, 102, 241, 0.25);
    color: #6366f1;
}

/* äº®è‰²ä¸»é¢˜ - API è­¦å‘Šæ¨ªå¹… */
[data-theme="light"] .api-warning-banner.info {
    background: linear-gradient(135deg, rgba(6, 182, 212, 0.08), rgba(99, 102, 241, 0.05));
    border-color: rgba(6, 182, 212, 0.2);
}

[data-theme="light"] .api-warning-banner.warning {
    background: linear-gradient(135deg, rgba(251, 191, 36, 0.08), rgba(245, 158, 11, 0.05));
    border-color: rgba(251, 191, 36, 0.2);
}

[data-theme="light"] .warning-content strong {
    color: #1e293b;
}

[data-theme="light"] .warning-content p {
    color: #64748b;
}

/* äº®è‰²ä¸»é¢˜ - Logoå›¾æ ‡ (å¢å¼ºå¯è§æ€§) */
[data-theme="light"] .ai-logo {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.06));
    border-radius: 50%;
}

[data-theme="light"] .logo-core {
    background: linear-gradient(135deg, #4f46e5, #7c3aed, #0891b2);
    box-shadow: 0 4px 20px rgba(79, 70, 229, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.2);
}

[data-theme="light"] .logo-orbit {
    border-top-color: rgba(79, 70, 229, 0.7);
    border-right-color: rgba(124, 58, 237, 0.5);
    border-bottom-color: transparent;
    border-left-color: transparent;
}

[data-theme="light"] .logo-orbit.orbit-2 {
    border-top-color: rgba(8, 145, 178, 0.6);
    border-right-color: rgba(6, 182, 212, 0.4);
}

[data-theme="light"] .logo-orbit::before {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    box-shadow: 0 0 15px rgba(79, 70, 229, 0.8);
}

/* äº®è‰²ä¸»é¢˜ - æ¬¢è¿Logoçƒä½“ (å¢å¼ºå¯è§æ€§) */
[data-theme="light"] .welcome-logo {
    background: radial-gradient(circle, rgba(99, 102, 241, 0.06) 0%, transparent 70%);
    border-radius: 50%;
}

[data-theme="light"] .logo-sphere {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #0891b2 100%);
    box-shadow: 0 8px 40px rgba(79, 70, 229, 0.45), inset 0 0 25px rgba(255, 255, 255, 0.2);
}

[data-theme="light"] .ring {
    border-color: rgba(79, 70, 229, 0.35);
}

[data-theme="light"] .ring-2 {
    border-color: rgba(124, 58, 237, 0.28);
}

[data-theme="light"] .ring-3 {
    border-color: rgba(8, 145, 178, 0.22);
}
</style>
{% endblock %}

{% block content %}
<div class="ai-chat-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="ai-page-header">
        <div class="header-left">
            <div class="ai-logo">
                <div class="logo-core"><i class="fas fa-brain"></i></div>
                <div class="logo-orbit"></div>
                <div class="logo-orbit orbit-2"></div>
            </div>
            <div class="header-info">
                <h1>NEXUS AI</h1>
                <p>
                    <span class="status-indicator">
                        <span class="status-dot"></span>åœ¨çº¿
                    </span>
                    DeepSeek æ¨¡å‹é©±åŠ¨
                </p>
            </div>
        </div>
        <div class="header-actions">
            <button class="action-btn" onclick="clearChat()" title="æ¸…ç©ºå¯¹è¯"><i class="fas fa-trash-alt"></i></button>
            <button class="action-btn" onclick="exportChat()" title="å¯¼å‡ºå¯¹è¯"><i class="fas fa-download"></i></button>
            <a href="{{ url_for('system.ai_settings') }}" class="action-btn" title="AI è®¾ç½®"><i class="fas fa-cog"></i></a>
        </div>
    </div>

    {% if show_fallback_mode %}
    <div class="api-warning-banner info">
        <i class="fas fa-info-circle"></i>
        <div class="warning-content">
            <strong>ğŸ¤– æœ¬åœ°å›é€€æ¨¡å¼å·²å¯ç”¨</strong>
            <p>ç³»ç»Ÿæ­£åœ¨ä½¿ç”¨æœ¬åœ°å›é€€é€»è¾‘ã€‚å¦‚éœ€æ›´å¼ºå¤§çš„ AI èƒ½åŠ›ï¼Œè¯·å‰å¾€ <a href="{{ url_for('system.ai_settings') }}">AI è®¾ç½®</a> é…ç½® DeepSeek API Keyã€‚</p>
        </div>
    </div>
    {% elif not has_real_key %}
    <div class="api-warning-banner warning">
        <i class="fas fa-exclamation-triangle"></i>
        <div class="warning-content">
            <strong>âš ï¸ API Key æœªé…ç½®</strong>
            <p>è¯·å‰å¾€ <a href="{{ url_for('system.ai_settings') }}">AI è®¾ç½®</a> é…ç½®æ‚¨çš„ DeepSeek API Key ä»¥å¯ç”¨å®Œæ•´ AI åŠŸèƒ½</p>
        </div>
    </div>
    {% endif %}

    <div class="chat-layout">
        <!-- å·¦ä¾§ä¼šè¯åˆ—è¡¨ -->
        <div class="sessions-panel">
            <div class="panel-header">
                <span><i class="fas fa-comments"></i> ä¼šè¯å†å²</span>
                <button class="new-chat-btn" onclick="newChat()" title="æ–°å»ºå¯¹è¯"><i class="fas fa-plus"></i></button>
            </div>
            <div class="sessions-list" id="sessionList">
                <div class="session-item active">
                    <i class="fas fa-message"></i>
                    <div class="session-info">
                        <span class="session-name">æ–°å¯¹è¯</span>
                        <span class="session-time">åˆšåˆš</span>
                    </div>
                </div>
            </div>
            <div class="quick-features">
                <div class="feature-title">âš¡ å¿«æ·åŠŸèƒ½</div>
                <button class="feature-btn" onclick="sendQuickMessage('åˆ†ææœ¬æœˆé”€å”®æ•°æ®å¹¶ç»™å‡ºä¼˜åŒ–å»ºè®®')">
                    <i class="fas fa-chart-line"></i><span>é”€å”®åˆ†æ</span>
                </button>
                <button class="feature-btn" onclick="sendQuickMessage('æ£€æŸ¥åº“å­˜é¢„è­¦å•†å“å¹¶å»ºè®®è¡¥è´§æ–¹æ¡ˆ')">
                    <i class="fas fa-boxes"></i><span>åº“å­˜æ£€æŸ¥</span>
                </button>
                <button class="feature-btn" onclick="sendQuickMessage('ç”Ÿæˆæœ¬å‘¨å·¥ä½œæ€»ç»“æŠ¥å‘Š')">
                    <i class="fas fa-file-alt"></i><span>å·¥ä½œæ€»ç»“</span>
                </button>
                <button class="feature-btn" onclick="sendQuickMessage('åˆ†æå®¢æˆ·è´­ä¹°è¡Œä¸ºå’Œåå¥½')">
                    <i class="fas fa-users"></i><span>å®¢æˆ·åˆ†æ</span>
                </button>
            </div>
        </div>

        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="chat-main">
            <div class="messages-container" id="chatMessages">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-logo">
                        <div class="logo-sphere"><i class="fas fa-robot"></i></div>
                        <div class="logo-rings">
                            <div class="ring ring-1"></div>
                            <div class="ring ring-2"></div>
                            <div class="ring ring-3"></div>
                        </div>
                    </div>
                    <h2>æ‚¨å¥½ï¼Œæˆ‘æ˜¯ NEXUS AI</h2>
                    <p>æ‚¨çš„æ™ºèƒ½ä¼ä¸šåŠ©æ‰‹ï¼Œéšæ—¶ä¸ºæ‚¨æä¾›æ•°æ®åˆ†æã€æŠ¥å‘Šç”Ÿæˆã€ç­–ç•¥å»ºè®®ç­‰æœåŠ¡</p>
                    <div class="suggestion-cards">
                        <div class="suggestion-card" onclick="sendQuickMessage('å¸®æˆ‘åˆ†æä»Šæ—¥çš„é”€å”®æ•°æ®è¶‹åŠ¿')">
                            <i class="fas fa-chart-pie"></i><span>åˆ†æé”€å”®æ•°æ®</span>
                        </div>
                        <div class="suggestion-card" onclick="sendQuickMessage('ç”Ÿæˆä¸€ä»½åº“å­˜ç›˜ç‚¹æŠ¥å‘Š')">
                            <i class="fas fa-warehouse"></i><span>åº“å­˜ç›˜ç‚¹æŠ¥å‘Š</span>
                        </div>
                        <div class="suggestion-card" onclick="sendQuickMessage('å¦‚ä½•æå‡å®¢æˆ·ç•™å­˜ç‡ï¼Ÿ')">
                            <i class="fas fa-lightbulb"></i><span>è·å–ç­–ç•¥å»ºè®®</span>
                        </div>
                        <div class="suggestion-card" onclick="sendQuickMessage('å¸®æˆ‘å†™ä¸€å°å®¢æˆ·æ„Ÿè°¢é‚®ä»¶')">
                            <i class="fas fa-envelope"></i><span>æ’°å†™å•†åŠ¡é‚®ä»¶</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... (Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ)" rows="1"></textarea>
                    <div class="input-tools">
                        <label class="context-toggle">
                            <input type="checkbox" id="contextMode" checked>
                            <span class="toggle-label">ä¿æŒä¸Šä¸‹æ–‡</span>
                        </label>
                    </div>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const welcomeScreen = document.getElementById('welcomeScreen');
const sessionList = document.getElementById('sessionList');

let isProcessing = false;
let messageHistory = [];
let currentSessionId = null;
let sessions = [];

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadSessions();
    
    // é¡µé¢ç¦»å¼€æ—¶ä¿å­˜å½“å‰ä¼šè¯
    window.addEventListener('beforeunload', function() {
        if (currentSessionId) {
            localStorage.setItem('nexus_ai_last_session', currentSessionId);
        }
    });
    
    // æ¢å¤ä¸Šæ¬¡ä¼šè¯
    const lastSessionId = localStorage.getItem('nexus_ai_last_session');
    if (lastSessionId) {
        setTimeout(() => loadSession(lastSessionId), 500);
    }
});

messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 160) + 'px';
});

messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// åŠ è½½ä¼šè¯åˆ—è¡¨
async function loadSessions() {
    try {
        const response = await fetch('/ai/api/sessions');
        const data = await response.json();
        if (data.success) {
            sessions = data.sessions;
            renderSessionList();
        }
    } catch (error) {
        console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ¸²æŸ“ä¼šè¯åˆ—è¡¨
function renderSessionList() {
    sessionList.innerHTML = '';
    
    // æ·»åŠ "æ–°å¯¹è¯"é¡¹
    const newChatItem = document.createElement('div');
    newChatItem.className = `session-item ${!currentSessionId ? 'active' : ''}`;
    newChatItem.onclick = () => newChat();
    newChatItem.innerHTML = `
        <i class="fas fa-plus-circle"></i>
        <div class="session-info">
            <span class="session-name">æ–°å¯¹è¯</span>
            <span class="session-time">å¼€å§‹æ–°è¯é¢˜</span>
        </div>
    `;
    sessionList.appendChild(newChatItem);
    
    // æ·»åŠ å†å²ä¼šè¯
    sessions.forEach(session => {
        const item = document.createElement('div');
        item.className = `session-item ${session.id === currentSessionId ? 'active' : ''}`;
        item.onclick = () => loadSession(session.id);
        
        const time = formatSessionTime(session.lastMessageAt || session.createdAt);
        item.innerHTML = `
            <i class="fas fa-message"></i>
            <div class="session-info">
                <span class="session-name">${escapeHtml(session.title)}</span>
                <span class="session-time">${time}</span>
            </div>
            <button class="session-delete" onclick="event.stopPropagation(); deleteSession(${session.id})" title="åˆ é™¤ä¼šè¯">
                <i class="fas fa-times"></i>
            </button>
        `;
        sessionList.appendChild(item);
    });
}

// æ ¼å¼åŒ–ä¼šè¯æ—¶é—´
function formatSessionTime(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'åˆšåˆš';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
    if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
    return date.toLocaleDateString('zh-CN');
}

// åˆ›å»ºæ–°ä¼šè¯
async function createSession(firstMessage) {
    try {
        const response = await fetch('/ai/api/sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ first_message: firstMessage })
        });
        const data = await response.json();
        if (data.success) {
            currentSessionId = data.session.id;
            await loadSessions();
            return data.session.id;
        }
    } catch (error) {
        console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
    }
    return null;
}

// åŠ è½½ä¼šè¯
async function loadSession(sessionId) {
    try {
        const response = await fetch(`/ai/api/sessions/${sessionId}`);
        const data = await response.json();
        if (data.success) {
            currentSessionId = sessionId;
            messageHistory = [];
            
            // éšè—æ¬¢è¿å±å¹•
            if (welcomeScreen) welcomeScreen.style.display = 'none';
            
            // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“æ¶ˆæ¯
            chatMessages.innerHTML = '';
            
            data.session.messages.forEach(msg => {
                addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai', false, new Date(msg.createdAt));
                messageHistory.push({ role: msg.role, content: msg.content });
            });
            
            renderSessionList();
            localStorage.setItem('nexus_ai_last_session', sessionId);
        }
    } catch (error) {
        console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
    }
}

// åˆ é™¤ä¼šè¯
async function deleteSession(sessionId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) return;
    
    try {
        const response = await fetch(`/ai/api/sessions/${sessionId}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        if (data.success) {
            if (currentSessionId === sessionId) {
                newChat();
            }
            await loadSessions();
        }
    } catch (error) {
        console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
    }
}

// å‘é€æ¶ˆæ¯
async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || isProcessing) return;
    
    if (welcomeScreen) welcomeScreen.style.display = 'none';
    
    addMessage(message, 'user');
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
    isProcessing = true;
    sendBtn.disabled = true;
    const typingIndicator = showTypingIndicator();
    
    try {
        const response = await fetch('{{ url_for("ai.api_chat") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                sessionId: currentSessionId,
                context: document.getElementById('contextMode').checked ? messageHistory : []
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error:', response.status, errorText);
            typingIndicator.remove();
            addMessage(`è¯·æ±‚å¤±è´¥ (${response.status}): ${errorText || 'æœªçŸ¥é”™è¯¯'}`, 'ai', true);
            isProcessing = false;
            sendBtn.disabled = false;
            return;
        }
        
        const data = await response.json();
        typingIndicator.remove();
        
        if (data.success) {
            addMessage(data.content, 'ai');
            messageHistory.push({ role: 'user', content: message });
            messageHistory.push({ role: 'assistant', content: data.content });
            
            // æ›´æ–°ä¼šè¯IDï¼ˆå¦‚æœæ˜¯æ–°åˆ›å»ºçš„ï¼‰
            if (data.sessionId) {
                currentSessionId = data.sessionId;
                await loadSessions();
            }
        } else {
            addMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'ai', true);
        }
    } catch (error) {
        typingIndicator.remove();
        console.error('Fetch Error:', error);
        addMessage('ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚é”™è¯¯: ' + error.message, 'ai', true);
    }
    
    isProcessing = false;
    sendBtn.disabled = false;
}

function addMessage(content, type, isError = false, timestamp = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    
    const avatar = type === 'ai' 
        ? '<i class="fas fa-robot"></i>'
        : '{{ current_user.username[:1].upper() if current_user.is_authenticated else "U" }}';
    
    const time = (timestamp || new Date()).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    
    let formattedContent = content
        .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    
    messageDiv.innerHTML = `
        <div class="msg-avatar">${avatar}</div>
        <div class="msg-content" ${isError ? 'style="border-color: rgba(239, 68, 68, 0.5);"' : ''}>
            ${formattedContent}
            <div class="msg-time"><i class="far fa-clock"></i> ${time}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'typing-indicator';
    indicator.innerHTML = `
        <div class="msg-avatar" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white;">
            <i class="fas fa-robot"></i>
        </div>
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    chatMessages.appendChild(indicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return indicator;
}

function sendQuickMessage(message) {
    messageInput.value = message;
    sendMessage();
}

function newChat() {
    currentSessionId = null;
    messageHistory = [];
    chatMessages.innerHTML = '';
    localStorage.removeItem('nexus_ai_last_session');
    
    if (welcomeScreen) {
        chatMessages.appendChild(welcomeScreen);
        welcomeScreen.style.display = 'flex';
    }
    
    renderSessionList();
}

function clearChat() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
        if (currentSessionId) {
            deleteSession(currentSessionId);
        } else {
            newChat();
        }
    }
}

function exportChat() {
    if (messageHistory.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å¯¹è¯å†…å®¹');
        return;
    }
    
    let content = '# NEXUS AI å¯¹è¯è®°å½•\n\n> å¯¼å‡ºæ—¶é—´ï¼š' + new Date().toLocaleString('zh-CN') + '\n\n---\n\n';
    messageHistory.forEach(msg => {
        const role = msg.role === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ¤– AI';
        content += `## ${role}\n\n${msg.content}\n\n---\n\n`;
    });
    
    const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `nexus-ai-chat-${new Date().toISOString().slice(0,10)}.md`;
    a.click();
}

// å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
